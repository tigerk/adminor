<template>
  <div class="project-info-form">
    <el-form ref="ruleFormRef" label-position="top" :rules="focusBasicInfoRules">
      <!-- é¡¹ç›®ä¿¡æ¯ -->
      <div class="section">
        <h3 class="section-title">é¡¹ç›®ä¿¡æ¯</h3>
        <el-row :gutter="20" class="form-row">
          <el-col :span="5">
            <el-form-item class="el-form-item" label="è”ç³»ç”µè¯" required>
              <el-input v-model="formData.phone" placeholder="è¯·è¾“å…¥è”ç³»ç”µè¯" />
            </el-form-item>
          </el-col>
          <el-col :span="5">
            <el-form-item label="ç”¨æ°´" required class="el-form-item">
              <el-select v-model="formData.water" placeholder="è¯·é€‰æ‹©">
                <el-option label="å•†ä¸šç”¨æ°´" value="commercial" />
                <el-option label="æ°‘ç”¨æ°´" value="residential" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="5">
            <el-form-item label="ç”¨ç”µ" required>
              <el-select v-model="formData.electricity" placeholder="è¯·é€‰æ‹©">
                <el-option label="å•†ä¸šç”¨ç”µ" value="commercial" />
                <el-option label="æ°‘ç”¨ç”µ" value="residential" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="5">
            <el-form-item label="ä¾›æš–ä¿¡æ¯" required>
              <el-select v-model="formData.heating" placeholder="è¯·é€‰æ‹©">
                <el-option label="é›†ä¸­ä¾›æš–" value="central" />
                <el-option label="ç‹¬ç«‹ä¾›æš–" value="independent" />
              </el-select>
            </el-form-item>
          </el-col>
          <el-col :span="4">
            <el-form-item label="&nbsp;">
              <el-checkbox v-model="formData.hasGas">æœ‰ç‡ƒæ°”</el-checkbox>
              <el-checkbox v-model="formData.hasElevator">æœ‰ç”µæ¢¯</el-checkbox>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="20" class="form-row">
          <el-col :span="24">
            <el-form-item label="é¡¹ç›®é…ç½®" required>
              <el-space wrap size="large" class="items-start">
                <el-checkbox v-model="formData.facilities.laundry" border>æ´—è¡£æˆ¿</el-checkbox>
                <el-checkbox v-model="formData.facilities.hotWater" border>çƒ­æ°´å™¨</el-checkbox>
                <el-checkbox v-model="formData.facilities.drinkingWater" border>é¥®æ°´æœº</el-checkbox>
                <el-checkbox v-model="formData.facilities.kitchen" border>å¨æˆ¿</el-checkbox>
                <el-checkbox v-model="formData.facilities.parking" border>åœè½¦ä½</el-checkbox>
                <el-checkbox v-model="formData.facilities.coffee" border>å’–å•¡å…</el-checkbox>
                <el-checkbox v-model="formData.facilities.tv" border>ç”µè§†</el-checkbox>
                <el-checkbox v-model="formData.facilities.fridge" border>å†°ç®±</el-checkbox>
                <el-checkbox v-model="formData.facilities.microwave" border>å¾®æ³¢ç‚‰</el-checkbox>
                <el-checkbox v-model="formData.facilities.washingMachine" border>æ´—è¡£æœº</el-checkbox>
                <el-checkbox v-model="formData.facilities.airCondition" border>ç©ºè°ƒ</el-checkbox>
                <el-checkbox v-model="formData.facilities.oven" border>çƒ¤ç®±</el-checkbox>
                <el-checkbox v-model="formData.facilities.security24" border>24å°æ—¶ä¿å®‰</el-checkbox>
                <el-checkbox v-model="formData.facilities.regularCleaning" border>å¸¸è§„ä¿æ´</el-checkbox>
                <el-checkbox v-model="formData.facilities.gym" border>å¥èº«æˆ¿</el-checkbox>
                <el-checkbox v-model="formData.facilities.reception" border>å‰å°</el-checkbox>
                <el-checkbox v-model="formData.facilities.garbageDisposal" border>ä»£æ”¶å¿«é€’</el-checkbox>
                <el-checkbox v-model="formData.facilities.swimmingPool" border>æ¸¸æ³³æ± </el-checkbox>
                <el-checkbox v-model="formData.facilities.publicWifi" border>å…¬å…±WIFI</el-checkbox>
                <el-checkbox v-model="formData.facilities.supermarket" border>è¶…å¸‚</el-checkbox>
                <el-checkbox v-model="formData.facilities.elevator" border>ç”µæ¢¯</el-checkbox>
              </el-space>
            </el-form-item>
          </el-col>
        </el-row>
      </div>

      <!-- é¡¹ç›®ä»‹ç» -->
      <div class="section">
        <el-form-item label="é¡¹ç›®ä»‹ç»">
          <el-input v-model="formData.projectDescription" type="text" placeholder="è¯·è¾“å…¥é¡¹ç›®ä»‹ç»" :rows="4" maxlength="500" show-word-limit />
        </el-form-item>
      </div>

      <!-- å•†åœˆä»‹ç» -->
      <div class="section">
        <el-form-item label="å•†åœˆä»‹ç»">
          <el-input v-model="formData.businessDescription" type="text" placeholder="è¯·è¾“å…¥å•†åœˆä»‹ç»" :rows="3" maxlength="500" show-word-limit />
        </el-form-item>
      </div>

      <!-- é¡¹ç›®æ ‡ç­¾ -->
      <div class="section">
        <el-form-item label="é¡¹ç›®æ ‡ç­¾ (æ–¹æ¡ˆäºŒ)">
          <div class="tag-section">
            <el-select v-model="formData.tags" multiple filterable allow-create default-first-option :reserve-keyword="false" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ " class="full-width">
              <el-option v-for="item in tagOptions" :key="item.value" :label="item.label" :value="item.value" />
            </el-select>
          </div>
        </el-form-item>
      </div>

      <!-- å¤‡æ³¨ -->
      <div class="section">
        <el-form-item label="å¤‡æ³¨">
          <div class="note-section">
            <el-input v-model="formData.notes" type="textarea" placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯" :rows="3" maxlength="500" show-word-limit />
          </div>
        </el-form-item>
      </div>

      <!-- é¡¹ç›®å›¾ç‰‡ -->
      <div class="section">
        <h3 class="section-title">é¡¹ç›®å›¾ç‰‡</h3>
        <el-upload
          v-model:file-list="fileList"
          drag
          multiple
          class="pure-upload"
          list-type="picture-card"
          accept="image/jpeg,image/png,image/gif"
          action="https://run.mocky.io/v3/3aa761d7-b0b3-4a03-96b3-6168d4f7467b"
          :limit="3"
          :headers="{ Authorization: 'eyJhbGciOiJIUzUxMiJ9.admin' }"
          :on-exceed="onExceed"
          :before-upload="onBefore"
        >
          <EpPlus class="m-auto mt-4" />
          <template #file="{ file }">
            <div v-if="file.status == 'ready' || file.status == 'uploading'" class="mt-[35%]! m-auto">
              <p class="font-medium">æ–‡ä»¶ä¸Šä¼ ä¸­</p>
              <el-progress class="mt-2!" :stroke-width="2" :text-inside="true" :show-text="false" :percentage="file.percentage" />
            </div>
            <div v-else @mouseenter.stop="imgDrop(file.uid)">
              <img class="el-upload-list__item-thumbnail select-none" :src="file.url" alt="" />
              <span id="pure-upload-item" :class="['el-upload-list__item-actions', fileList.length > 1 && 'cursor-move!']">
                <span title="æŸ¥çœ‹" class="hover:text-primary" @click="handlePictureCardPreview(file)">
                  <IconifyIconOffline :icon="Eye" class="hover:scale-125 duration-100" />
                </span>
                <span class="el-upload-list__item-delete" @click="handleRemove(file)">
                  <span title="ç§»é™¤" class="hover:text-[var(--el-color-danger)]">
                    <IconifyIconOffline :icon="Delete" class="hover:scale-125 duration-100" />
                  </span>
                </span>
              </span>
            </div>
          </template>
        </el-upload>
        <!-- æœ‰æ—¶æ–‡æ¡£æ²¡å†™å¹¶ä¸ä»£è¡¨æ²¡æœ‰ï¼Œå¤šçœ‹æºç å¥½å¤„å¤šå¤šğŸ˜ https://github.com/element-plus/element-plus/tree/dev/packages/components/image-viewer/src ï¼ˆemm...è¿™è®©æˆ‘æƒ³èµ·åˆšå¼€å§‹å†™è¿™ä¸ªé¡¹ç›®æ—¶ï¼Œå¾ˆå¤šä¸œè¥¿åªæœ‰è‹±æ–‡æˆ–è€…æ²¡æœ‰æ–‡æ¡£ï¼Œéœ€è¦çœ‹æºç æ—¶ï¼Œæƒ³ç¬‘ğŸ¥¹ã€‚é‚£äº›ç¾å¥½æ—¶å…‰éƒ½ç»™è¿™äº›å‘äº†ï¼Œgiaoï¼‰ -->
        <el-image-viewer
          v-if="dialogVisible"
          :initialIndex="curOpenImgIndex"
          :url-list="urlList"
          :zoom-rate="1.2"
          :max-scale="7"
          :min-scale="0.2"
          @close="dialogVisible = false"
          @switch="index => (curOpenImgIndex = index)"
        />
        <!-- å°†è‡ªå®šä¹‰å†…å®¹æ’å…¥åˆ°bodyé‡Œï¼Œæœ‰äº†å®ƒåœ¨å›¾ç‰‡é¢„è§ˆçš„æ—¶å€™ï¼Œæƒ³æ’å…¥ä¸ªåˆ†é¡µå™¨æˆ–è€…åˆ«çš„ä¸œä¸œåœ¨é¢„è§ˆåŒºæŸä¸ªä½ç½®å°±å¾ˆæ–¹ä¾¿å’¯ï¼ˆç”¨æˆ·éœ€æ±‚å¯ä»¥å¾ˆçµæ´»ï¼Œå¼€æºç»„ä»¶åº“å‡ ä¹ä¸å¯èƒ½å°½å–„å°½ç¾ï¼Œå¾ˆå¤šæ—¶å€™å¯»æ‰¾åˆ«çš„è§£å†³é€”å¾„æˆ–è®¸æ›´å¥½ï¼‰ -->
        <teleport to="body">
          <div v-if="fileList[curOpenImgIndex] && dialogVisible" effect="dark" round size="large" type="info" class="img-name">
            <p class="text-[#fff] dark:text-black">
              {{ fileList[curOpenImgIndex].name }}
            </p>
          </div>
        </teleport>
        <p class="el-upload__tip">å¯æ‹–æ‹½ä¸Šä¼ æœ€å¤š3å¼ å•ä¸ªä¸è¶…è¿‡2MBä¸”æ ¼å¼ä¸ºjpeg/png/gifçš„å›¾ç‰‡</p>
      </div>
    </el-form>
  </div>
</template>

<script setup lang="ts">
  import { computed, reactive, ref } from "vue";
  import type { UploadFile } from "element-plus";
  import { useRouter } from "vue-router";
  import { downloadByData, extractFields, getKeyList } from "@pureadmin/utils";
  import { message } from "@/utils/message";
  import Sortable from "sortablejs";
  import axios from "axios";
  import EpPlus from "~icons/ep/plus?width=30&height=30";
  import Eye from "~icons/ri/eye-line";
  import Delete from "~icons/ri/delete-bin-7-line";
  import { focusBasicInfoRules } from "@/views/house/focus/components/utils/rule";

  // é¢„è®¾æ ‡ç­¾é€‰é¡¹
  const tagOptions = ref([
    { label: "ç²¾è£…ä¿®", value: "ç²¾è£…ä¿®" },
    { label: "è¿‘åœ°é“", value: "è¿‘åœ°é“" },
    { label: "å•†åœˆæ ¸å¿ƒ", value: "å•†åœˆæ ¸å¿ƒ" },
    { label: "æ‹åŒ…å…¥ä½", value: "æ‹åŒ…å…¥ä½" },
    { label: "é«˜æ€§ä»·æ¯”", value: "é«˜æ€§ä»·æ¯”" }
  ]);

  interface FormData {
    phone: string;
    water: string;
    electricity: string;
    heating: string;
    hasGas: boolean;
    hasElevator: boolean;
    facilities: {
      laundry: boolean;
      hotWater: boolean;
      drinkingWater: boolean;
      kitchen: boolean;
      parking: boolean;
      coffee: boolean;
      tv: boolean;
      fridge: boolean;
      microwave: boolean;
      washingMachine: boolean;
      airCondition: boolean;
      oven: boolean;
      security24: boolean;
      regularCleaning: boolean;
      gym: boolean;
      reception: boolean;
      garbageDisposal: boolean;
      swimmingPool: boolean;
      publicWifi: boolean;
      supermarket: boolean;
      elevator: boolean;
    };
    projectDescription: string;
    businessDescription: string;
    tags: string[];
    notes: string;
  }

  const formData = reactive<FormData>({
    phone: "",
    water: "commercial",
    electricity: "commercial",
    heating: "central",
    hasGas: true,
    hasElevator: true,
    facilities: {
      laundry: true,
      hotWater: true,
      drinkingWater: false,
      kitchen: true,
      parking: true,
      coffee: false,
      tv: true,
      fridge: true,
      microwave: true,
      washingMachine: false,
      airCondition: true,
      oven: false,
      security24: true,
      regularCleaning: true,
      gym: true,
      reception: true,
      garbageDisposal: true,
      swimmingPool: false,
      publicWifi: false,
      supermarket: false,
      elevator: true
    },
    projectDescription: "",
    businessDescription: "",
    tags: [],
    notes: ""
  });

  const handleImageChange = (file: UploadFile) => {
    console.log("ä¸Šä¼ æ–‡ä»¶:", file);
  };

  // å¯¼å‡ºè¡¨å•æ•°æ®ï¼Œä¾›çˆ¶ç»„ä»¶ä½¿ç”¨
  defineExpose({
    formData
  });

  const fileList = ref([]);
  const router = useRouter();
  const curOpenImgIndex = ref(0);
  const dialogVisible = ref(false);

  const urlList = computed(() => getKeyList(fileList.value, "url"));
  const imgInfos = computed(() => extractFields(fileList.value, "name", "size"));

  const getImgUrl = name => new URL(`./imgs/${name}.jpg`, import.meta.url).href;
  const srcList = Array.from({ length: 3 }).map((_, index) => {
    return getImgUrl(index + 1);
  });

  /** ä¸Šä¼ æ–‡ä»¶å‰æ ¡éªŒ */
  const onBefore = file => {
    if (!["image/jpeg", "image/png", "image/gif"].includes(file.type)) {
      message("åªèƒ½ä¸Šä¼ å›¾ç‰‡");
      return false;
    }
    const isExceed = file.size / 1024 / 1024 > 2;
    if (isExceed) {
      message(`å•ä¸ªå›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB`);
      return false;
    }
  };

  /** è¶…å‡ºæœ€å¤§ä¸Šä¼ æ•°æ—¶è§¦å‘ */
  const onExceed = () => {
    message("æœ€å¤šä¸Šä¼ 3å¼ å›¾ç‰‡ï¼Œè¯·å…ˆåˆ é™¤åœ¨ä¸Šä¼ ");
  };

  /** ç§»é™¤ä¸Šä¼ çš„æ–‡ä»¶ */
  const handleRemove = (file: UploadFile) => {
    fileList.value.splice(fileList.value.indexOf(file), 1);
  };

  /** å¤§å›¾é¢„è§ˆ */
  const handlePictureCardPreview = (file: UploadFile) => {
    curOpenImgIndex.value = fileList.value.findIndex(img => img.uid === file.uid);
    dialogVisible.value = true;
  };

  const getUploadItem = () => document.querySelectorAll("#pure-upload-item");

  /** ç¼©ç•¥å›¾æ‹–æ‹½æ’åº */
  const imgDrop = uid => {
    const CLASSNAME = "el-upload-list";
    const _curIndex = fileList.value.findIndex(img => img.uid === uid);
    getUploadItem()?.[_curIndex]?.classList?.add(`${CLASSNAME}__item-actions`);
    const wrapper: HTMLElement = document.querySelector(`.${CLASSNAME}`);
    Sortable.create(wrapper, {
      handle: `.${CLASSNAME}__item`,
      onEnd: ({ newIndex, oldIndex }) => {
        const oldFile = fileList.value[oldIndex];
        fileList.value.splice(oldIndex, 1);
        fileList.value.splice(newIndex, 0, oldFile);
        // fix: https://github.com/SortableJS/Sortable/issues/232 (firefox is ok, but chromium is bad. see https://bugs.chromium.org/p/chromium/issues/detail?id=410328)
        getUploadItem().forEach(ele => {
          ele.classList.remove(`${CLASSNAME}__item-actions`);
        });
      }
    });
  };

  /** ä¸‹è½½å›¾ç‰‡ */
  const onDownload = () => {
    [
      { name: "å·´æ—¦æœ¨.jpeg", type: "img" },
      { name: "æ­å–œå‘è´¢.png", type: "img" },
      { name: "å¯çˆ±åŠ¨ç‰©.gif", type: "gif" },
      { name: "pure-upload.csv", type: "other" },
      { name: "pure-upload.txt", type: "other" }
    ].forEach(img => {
      axios
        .get(`https://xiaoxian521.github.io/hyperlink/${img.type}/${img.name}`, {
          responseType: "blob"
        })
        .then(({ data }) => {
          downloadByData(data, img.name);
        });
    });
  };
</script>

<style lang="scss" scoped>
  :deep(.el-form-item--label-top .el-form-item__label) {
    font-size: 12px;
    color: #43464c;
  }

  .section {
    margin-bottom: 24px;
  }

  .section-title {
    margin-bottom: 16px;
    font-size: 16px;
    font-weight: 600;
    color: #303133;
  }

  .form-row {
    margin-bottom: 5px;
  }

  .tag-section,
  .note-section {
    width: 100%;
  }

  .tag-limit,
  .note-limit {
    margin-right: 8px;
    font-size: 12px;
    color: #909399;
  }

  .upload-demo {
    margin-top: 8px;
  }

  :deep(.el-form-item__label) {
    font-weight: 500;
    color: #606266;
  }

  :deep(.el-input__wrapper) {
    border-radius: 4px;
  }

  :deep(.el-select) {
    width: 100%;
  }

  :deep(.el-textarea__inner) {
    border-radius: 4px;
  }

  :deep(.el-upload-dragger) {
    border-radius: 6px;
  }

  :deep(.card-header) {
    display: flex;

    .header-right {
      display: flex;
      flex: auto;
      align-items: center;
      justify-content: flex-end;
      font-size: 14px;
    }
  }

  :deep(.pure-upload) {
    .el-upload-dragger {
      background-color: transparent;
      border: none;
    }
  }

  .img-name {
    position: absolute;
    bottom: 80px;
    left: 50%;
    z-index: 4000;
    padding: 5px 23px;
    background-color: var(--el-text-color-regular);
    border-radius: 22px;
    transform: translateX(-50%);
  }
</style>
